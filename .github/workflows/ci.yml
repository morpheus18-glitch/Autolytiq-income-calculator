name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ===========================================================================
  # Rust Build and Test
  # ===========================================================================
  rust:
    name: Rust Tests & WASM Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown
          components: clippy, rustfmt

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/calc-core -> target

      - name: Check formatting
        run: cargo fmt --manifest-path packages/calc-core/Cargo.toml -- --check

      - name: Run Clippy
        run: cargo clippy --manifest-path packages/calc-core/Cargo.toml -- -D warnings

      - name: Run unit tests
        run: cargo test --manifest-path packages/calc-core/Cargo.toml

      - name: Run property tests
        run: cargo test --manifest-path packages/calc-core/Cargo.toml --test property_tests -- --test-threads=1

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build WASM package
        run: |
          cd packages/calc-wasm
          wasm-pack build --target web --out-dir pkg

      - name: Upload WASM artifact
        uses: actions/upload-artifact@v4
        with:
          name: calc-wasm
          path: packages/calc-wasm/pkg/
          retention-days: 7

  # ===========================================================================
  # Node.js Build and Test
  # ===========================================================================
  node:
    name: Node.js Build
    runs-on: ubuntu-latest
    needs: rust

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Download WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: calc-wasm
          path: packages/calc-wasm/pkg/

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm check

      - name: Run property tests
        run: pnpm --filter @autolytiq/web test || true

      - name: Build web
        run: pnpm build:web

      - name: Build server
        run: pnpm build:server || true

      - name: Build extension
        run: pnpm build:extension || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: |
            dist/
            packages/extension/dist/
          retention-days: 7

  # ===========================================================================
  # Security Audit
  # ===========================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run npm audit
        run: pnpm audit --audit-level=high || true
        continue-on-error: true

      - name: Run Cargo audit
        uses: actions-rs/audit-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  # ===========================================================================
  # Nix Build (optional)
  # ===========================================================================
  nix:
    name: Nix Build
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-24.05

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: autolytiq
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true

      - name: Build with Nix
        run: nix build .#calc-wasm --no-link || true

      - name: Run Nix checks
        run: nix flake check || true

  # ===========================================================================
  # Deploy (main branch only)
  # ===========================================================================
  deploy:
    name: Deploy
    needs: [rust, node]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Download WASM artifact
        uses: actions/download-artifact@v4
        with:
          name: calc-wasm
          path: packages/calc-wasm/pkg/

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            cd /root/income-calculator-autolytiq

            # Pull latest code
            git pull origin main

            # Install pnpm if not present
            command -v pnpm || npm install -g pnpm

            # Install dependencies
            pnpm install --frozen-lockfile

            # Build WASM (if Rust is installed)
            if command -v wasm-pack &> /dev/null; then
              cd packages/calc-wasm && wasm-pack build --target web && cd ../..
            fi

            # Build web and server
            pnpm build

            # Restart with PM2
            pm2 restart all || pm2 start ecosystem.config.cjs

            echo "Deployed at $(date)"

  # ===========================================================================
  # Extension Release (on tag)
  # ===========================================================================
  extension-release:
    name: Extension Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [rust, node]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download extension artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Package extension
        run: |
          cd packages/extension/dist
          zip -r ../../../extension-${{ github.ref_name }}.zip .

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: extension-${{ github.ref_name }}.zip
          draft: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
